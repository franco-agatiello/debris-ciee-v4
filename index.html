<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard | Debris Espaciales</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"/>
  <link rel="stylesheet" href="style.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    .selecting-rect { pointer-events: none; border: 2px dashed #0d6efd; background: rgba(13,110,253,.08); position: absolute; z-index: 5000; }
    .chart-container { min-height: 220px; padding: 12px 8px; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px rgba(44,62,80,0.07); }
    .chart-container canvas { max-width: 98%; max-height: 200px; margin: 0 auto; display: block; }
    #informe-resumen { font-size: 0.97em; font-weight: 500; }
    #imgMapaInforme { border: 1px solid #e5e7eb; border-radius: 8px; }
    .modal-xl { min-width: 97vw; }
    @media (max-width: 900px) {
      .modal-xl { min-width: 100vw; }
      .chart-container { min-height: 180px; padding: 7px 3px; }
      #imgMapaInforme { max-width: 98vw; }
    }
  </style>
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.165.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.165.0/examples/jsm/"
      }
    }
  </script>
</head>
<body>
  <div class="container-fluid">
    <div class="row flex-nowrap">
      <aside class="col-auto p-2 bg-light" id="sidebar">
        <a href="https://www.ciee.unlp.edu.ar/" target="_blank" rel="noopener">
          <img src="img/Captura de pantalla 2025-06-06 211123.png" alt="Logo CIEE" class="sidebar-logo mb-3">
        </a>
        <h4>Filtros</h4>
        <div class="accordion mb-2" id="filtrosAccordion">
          <!-- País de origen -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingPais">
              <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePais" aria-expanded="true" aria-controls="collapsePais">
                País de origen
              </button>
            </h2>
            <div id="collapsePais" class="accordion-collapse collapse show" aria-labelledby="headingPais" data-bs-parent="#filtrosAccordion">
              <div class="accordion-body">
                <div class="dropdown mb-2" id="pais-dropdown">
                  <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" id="dropdownPaisBtn" data-bs-toggle="dropdown" aria-expanded="false" data-value="">
                    Todos
                  </button>
                  <ul class="dropdown-menu w-100" id="dropdownPaisMenu" style="max-height:220px; overflow-y:auto;"></ul>
                </div>
              </div>
            </div>
          </div>
          <!-- Clase de objeto -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingClase">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseClase" aria-expanded="false" aria-controls="collapseClase">
                Clase de objeto
              </button>
            </h2>
            <div id="collapseClase" class="accordion-collapse collapse" aria-labelledby="headingClase" data-bs-parent="#filtrosAccordion">
              <div class="accordion-body">
                <div class="dropdown mb-2" id="clase-dropdown">
                  <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" id="dropdownClaseBtn" data-bs-toggle="dropdown" aria-expanded="false" data-value="">
                    Seleccionar clase
                  </button>
                  <ul class="dropdown-menu w-100" id="dropdownClaseMenu" style="max-height:220px; overflow-y:auto;"></ul>
                </div>
              </div>
            </div>
          </div>
          <!-- Fecha de reentrada -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingFecha">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFecha" aria-expanded="false" aria-controls="collapseFecha">
                Fecha de reentrada
              </button>
            </h2>
            <div id="collapseFecha" class="accordion-collapse collapse" aria-labelledby="headingFecha" data-bs-parent="#filtrosAccordion">
              <div class="accordion-body">
                <div class="row g-1 mb-2">
                  <div class="col"><input type="date" class="form-control" id="fecha-desde"></div>
                  <div class="col"><input type="date" class="form-control" id="fecha-hasta"></div>
                </div>
              </div>
            </div>
          </div>
          <!-- Inclinación órbita -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingIncl">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseIncl" aria-expanded="false" aria-controls="collapseIncl">
                Inclinación órbita (°)
              </button>
            </h2>
            <div id="collapseIncl" class="accordion-collapse collapse" aria-labelledby="headingIncl" data-bs-parent="#filtrosAccordion">
              <div class="accordion-body">
                <div class="row g-1 mb-2">
                  <div class="col"><input type="number" class="form-control" id="inclinacion-min" placeholder="Mín" min="0" max="180"></div>
                  <div class="col"><input type="number" class="form-control" id="inclinacion-max" placeholder="Máx" min="0" max="180"></div>
                </div>
              </div>
            </div>
          </div>
          <!-- Masa en órbita -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingMasa">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMasa" aria-expanded="false" aria-controls="collapseMasa">
                Masa en órbita (kg)
              </button>
            </h2>
            <div id="collapseMasa" class="accordion-collapse collapse" aria-labelledby="headingMasa" data-bs-parent="#filtrosAccordion">
              <div class="accordion-body">
                <div class="row g-1 mb-2">
                  <div class="col"><input type="number" class="form-control" id="masa-orbita-min" placeholder="Mín" min="0"></div>
                  <div class="col"><input type="number" class="form-control" id="masa-orbita-max" placeholder="Máx" min="0"></div>
                </div>
              </div>
            </div>
          </div>
          <!-- Constelaciones -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingConst">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseConst" aria-expanded="false" aria-controls="collapseConst">
                Constelaciones
              </button>
            </h2>
            <div id="collapseConst" class="accordion-collapse collapse" aria-labelledby="headingConst" data-bs-parent="#filtrosAccordion">
              <div class="accordion-body">
                <div class="btn-group w-100 mb-2" role="group" aria-label="Constelaciones">
                  <input type="radio" class="btn-check" name="rb-const" id="const-all" autocomplete="off" checked>
                  <label class="btn btn-outline-secondary" for="const-all">Todo</label>
                  <input type="radio" class="btn-check" name="rb-const" id="const-yes" autocomplete="off">
                  <label class="btn btn-outline-secondary" for="const-yes">Solo</label>
                  <input type="radio" class="btn-check" name="rb-const" id="const-no" autocomplete="off">
                  <label class="btn btn-outline-secondary" for="const-no">Sin</label>
                </div>
              </div>
            </div>
          </div>
          <!-- Región (Lat/Lon) + selección rectangular -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingRegion">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRegion" aria-expanded="false" aria-controls="collapseRegion">
                Región (lat/lon)
              </button>
            </h2>
            <div id="collapseRegion" class="accordion-collapse collapse" aria-labelledby="headingRegion" data-bs-parent="#filtrosAccordion">
              <div class="accordion-body">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <div>
                    <span class="fw-semibold">Zona geográfica</span>
                  </div>
                  <div class="btn-group">
                    <button class="btn btn-sm btn-outline-primary" id="btn-select-rect">
                      <i class="bi bi-bounding-box"></i> Seleccionar Zona
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" id="btn-clear-rect">Limpiar</button>
                  </div>
                </div>
                <div class="row g-1 mt-1">
                  <div class="col-6"><input type="number" step="any" class="form-control" id="lat-min" placeholder="Lat mín"></div>
                  <div class="col-6"><input type="number" step="any" class="form-control" id="lat-max" placeholder="Lat máx"></div>
                  <div class="col-6"><input type="number" step="any" class="form-control" id="lon-min" placeholder="Lon mín"></div>
                  <div class="col-6"><input type="number" step="any" class="form-control" id="lon-max" placeholder="Lon máx"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <button id="btn-informe" class="btn btn-primary w-100 mb-2">Generar informe</button>
        <div class="mt-2 small text-muted">Registros mostrados: <span id="countSpan">0</span></div>
        <div class="mt-4 d-grid gap-2">
          <button type="button" class="btn btn-primary" id="modo-puntos">
            <i class="bi bi-geo-alt-fill me-1"></i>Puntos
          </button>
          <button type="button" class="btn btn-secondary" id="modo-calor">
            <i class="bi bi-fire me-1"></i>Calor
          </button>
        </div>
      </aside>
      <main class="col p-0" id="main-col">
        <div id="map"></div>
      </main>
    </div>
    <footer id="footer-ciee" class="d-none d-md-block">
      <span>
        © Copyright CIEE 2025 - All rights reserved. 
        <a href="https://www.ciee.unlp.edu.ar/" target="_blank" rel="noopener">CIEE</a>
      </span>
    </footer>
  </div>
 <!-- Modal de Informe y los modals de Trayectoria y Órbita 3D incluidos -->
<div class="modal fade" id="informeModal" tabindex="-1" aria-labelledby="informeLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="informeLabel">Informe de reentradas (según filtros activos)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div id="informe-loading" style="display:none;align-items:center;justify-content:center;min-height:220px;">
          <div class="spinner-border text-primary" role="status"></div>
          <span class="ms-3">Generando informe...</span>
        </div>
        <div id="informe-resumen" class="mb-3"></div>
        <div class="row mb-2">
          <div class="col-md-6 chart-container mb-3">
            <h6 class="mb-2">Distribución por tramo (año de caída)</h6>
            <canvas id="chartPieTramos" width="350" height="170"></canvas>
          </div>
          <div class="col-md-6 chart-container mb-3">
            <h6 class="mb-2">Distribución por clase de objeto</h6>
            <canvas id="chartBarClases" width="350" height="170"></canvas>
          </div>
        </div>
        <div class="row mb-2">
          <div class="col-md-6 chart-container mb-3">
            <h6 class="mb-2">Masa reingresada (kg) por tipo de debris</h6>
            <canvas id="chartBarTipoMasa" width="350" height="170"></canvas>
          </div>
          <div class="col-md-6 chart-container mb-3">
            <h6 class="mb-2">Tiempo en órbita</h6>
            <canvas id="chartPieTiempo" width="350" height="170"></canvas>
          </div>
        </div>
        <div class="col-12 chart-container">
          <h6 class="mb-2">Mapa de puntos (por año de caída)</h6>
          <canvas id="canvasMapaPuntos" width="650" height="320"></canvas>
        </div>
      </div>
      <div class="modal-footer">
        <button id="dlPDF" class="btn btn-success">Exportar PDF</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Trayectoria -->
<div class="modal fade" id="modalTrayectoria" tabindex="-1" aria-labelledby="trayectoriaLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="trayectoriaLabel">Trayectoria orbital (últimos TLE)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div id="trayectoriaInfo" class="mb-2"></div>
        <div id="trayectoriaMapContainer" style="width:100%;height:400px;">
          <div id="mapTrayectoria" style="width:100%;height:400px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Órbita 3D -->
<div class="modal fade" id="modalOrbita3D" tabindex="-1" aria-labelledby="orbita3DLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="orbita3DLabel">Órbita 3D (últimos TLE)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div id="orbita3DInfo" class="mb-2"></div>
        <div id="orbita3DContainer" style="width:100%;height:500px;background:#000;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/satellite.js/dist/satellite.min.js"></script>
  <script src="main.js" type="module"></script>
</body>
</html>
